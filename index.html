<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ClimaView ‚Äì Advanced Weather App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="weather.ico">
    <link rel="stylesheet" href="weatherapp.css">
</head>
<body>
    <header class="header" role="banner">
        <div class="logo" aria-label="ClimaView home"><i class="fas fa-cloud-sun"></i> ClimaView</div>
        <nav class="nav" aria-label="Main navigation">
            <a href="#" class="active">Home</a>
            <a href="#curr-sec">Current</a>
            <a href="#forecast-sec">Forecast</a>
        </nav>
        <button class="theme-btn" id="themeToggle" title="Toggle light/dark theme" aria-label="Toggle theme"><i class="fas fa-adjust"></i></button>
    </header>

    <div class="bg-anim"></div>

    <main class="main-wrap" role="main">
        <form id="loc-form" autocomplete="off">
            <h1><i class="fas fa-cloud-sun-rain"></i> Weather</h1>
            <div id="time"></div>
            <div id="last-update"></div>
            <div class="controls">
                <input type="text" id="cityIn" name="city" placeholder="Enter city or use GPS" aria-label="City name">
                <select id="unitSel" aria-label="Select temperature units">
                    <option value="c">¬∞C</option>
                    <option value="f">¬∞F</option>
                </select>
                <button type="submit" id="cityBtn">Search</button>
                <button type="button" id="gpsBtn" title="Use current location" aria-label="Use current location"><i class="fas fa-map-marker-alt"></i> GPS</button>
                </div>
            <div id="geo-prompt" role="alert"></div>
        </form>

        <section id="fav-sec" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;"><i class="fas fa-star"></i> Favorite Locations</h2>
            <div class="controls">
                <select id="favSelect" aria-label="Select a favorite city">
                    <option value="">Select a favorite...</option>
                </select>
                <button type="button" id="removeFavBtn" title="Remove selected favorite" aria-label="Remove favorite"><i class="fas fa-minus-circle"></i> Remove</button>
            </div>
            <p id="no-favs" style="font-style: italic; color: var(--light-secondary-text); margin-top: 10px; text-align: center; display: none;">No favorites saved yet. Search a city and click the ‚ù§Ô∏è icon!</p>
        </section>

        <section id="curr-sec" tabindex="-1" aria-labelledby="currentWeatherHeading">
            <h2 id="currentWeatherHeading"><i class="fas fa-map-marker-alt"></i> Current Weather</h2>
            <div id="weather-display" class="curr-weather"></div>
        </section>

        <section id="hourly-sec" aria-labelledby="hourlyForecastHeading">
            <h2 id="hourlyForecastHeading"><i class="fas fa-clock"></i> Hourly Forecast (Today)</h2>
            <div id="hourly-display" class="hourly-scroll"></div>
        </section>

        <section id="details-sec" aria-labelledby="weatherDetailsHeading">
            <h2 id="weatherDetailsHeading"><i class="fas fa-chart-bar"></i> Weather Details</h2>
            <div id="details-display" class="details-list"></div>
        </section>
        <section id="forecast-sec" aria-labelledby="forecastHeading">
            <h2 id="forecastHeading"><i class="fas fa-calendar-alt"></i> 3-Day Forecast</h2>
            <div id="forecast-display" class="day-grid"></div>
        </section>
        <div id="error-msg" class="error-msg" role="alert" style="display:none"></div>
    </main>

    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="footer-logo">
            <i class="fas fa-cloud-sun"></i> ClimaView
        </div>
        <div class="footer-links">
            <a href="#top">Back to Top</a>
        </div>
        <div class="copyright">
            &copy; 2025 ClimaView. All rights reserved.
        </div>
        <div class="powered-by">
            Powered by <a href="https://www.weatherapi.com/" target="_blank" rel="noopener noreferrer">WeatherAPI.com</a>
        </div>
    </footer>

    <script>
        const apiKey = "c8d6f96dd51e4b65966204756250407";

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const timeDiv = document.getElementById("time");
        const lastUpdatedDiv = document.getElementById("last-update");
        const cityInput = document.getElementById("cityIn");
        const unitSelect = document.getElementById("unitSel");
        const cityBtn = document.getElementById("cityBtn");
        const gpsBtn = document.getElementById("gpsBtn");
        const weatherDiv = document.getElementById("weather-display");
        const detailsDiv = document.getElementById("details-display");
        const hourlyForecastDiv = document.getElementById("hourly-display");
        const forecastDiv = document.getElementById("forecast-display");
        const errorDiv = document.getElementById("error-msg");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const geolocationPrompt = document.getElementById("geo-prompt");

        const favoriteSelect = document.getElementById("favSelect");
        const removeFavoriteBtn = document.getElementById("removeFavBtn");
        const noFavoritesMessage = document.getElementById("no-favs");

        const saveFavoriteBtn = document.createElement('button');
        saveFavoriteBtn.type = 'button';
        saveFavoriteBtn.id = 'saveFavBtn';
        saveFavoriteBtn.title = 'Add current city to favorites';
        saveFavoriteBtn.setAttribute('aria-label', 'Add current city to favorites');
        saveFavoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Save';
        document.querySelector('#loc-form .controls').appendChild(saveFavoriteBtn);

        let currentCityForFavorites = '';

        // --- Theme Toggling ---
        themeToggle.onclick = function() {
            document.body.classList.toggle('dark');
            // When toggling manually, remove any weather-specific classes
            document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
            localStorage.setItem("weatherly-theme", document.body.classList.contains("dark") ? "dark" : "light");
            localStorage.removeItem("weatherly-weather-theme"); // Clear previous weather theme preference
        };

        // Load stored theme on initial DOMContentLoaded
        window.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem("weatherly-theme") === "dark") {
                document.body.classList.add("dark");
            } else {
                // If not manual dark mode, try to load previous weather theme
                const storedWeatherTheme = localStorage.getItem("weatherly-weather-theme");
                if (storedWeatherTheme) {
                    document.body.classList.add(storedWeatherTheme);
                }
            }
        });

        // --- Loading Spinner Functions ---
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // --- Time Update Function ---
        function updateTime(localTime) {
            if (localTime) {
                const local = new Date(localTime.replace(' ', 'T'));
                timeDiv.textContent = `üïí Local Time: ${local.toLocaleString()}`;
            } else {
                timeDiv.textContent = "";
            }
        }

        function updateLastUpdated(updatedTime) {
            if (updatedTime) {
                lastUpdatedDiv.textContent = `Last Updated: ${new Date(updatedTime).toLocaleTimeString()}`;
            } else {
                lastUpdatedDiv.textContent = "";
            }
        }

        // --- Favorites Functions ---
        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            favoriteSelect.innerHTML = '<option value="">Select a favorite...</option>';
            if (favorites.length === 0) {
                noFavoritesMessage.style.display = 'block';
                favoriteSelect.disabled = true;
                removeFavoriteBtn.disabled = true;
            } else {
                noFavoritesMessage.style.display = 'none';
                favoriteSelect.disabled = false;
                removeFavoriteBtn.disabled = false;
                favorites.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    favoriteSelect.appendChild(option);
                });
            }
        }

        function saveFavorite(city) {
            let favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            if (city && !favorites.some(fav => fav.toLowerCase() === city.toLowerCase())) {
                favorites.push(city);
                localStorage.setItem('weatherly-favorites', JSON.stringify(favorites));
                loadFavorites();
                showError(`${city} added to favorites!`);
            } else if (city) {
                showError(`${city} is already in your favorites.`);
            } else {
                showError("Please search for a city first to save it.");
            }
        }

        function removeFavorite() {
            const cityToRemove = favoriteSelect.value;
            if (!cityToRemove) {
                showError("Please select a favorite to remove.");
                return;
            }
            let favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            favorites = favorites.filter(city => city !== cityToRemove);
            localStorage.setItem('weatherly-favorites', JSON.stringify(favorites));
            loadFavorites();
            showError(`${cityToRemove} removed from favorites.`);
            cityInput.value = '';
            if (currentCityForFavorites.toLowerCase() === cityToRemove.toLowerCase()) {
                 weatherDiv.innerHTML = "";
                 detailsDiv.innerHTML = "";
                 hourlyForecastDiv.innerHTML = "";
                 forecastDiv.innerHTML = "";
                 timeDiv.innerHTML = "";
                 lastUpdatedDiv.innerHTML = "";
                 currentCityForFavorites = '';
            }
        }

        // --- Persistence Functions ---
        function savePreferences(city, unit) {
            localStorage.setItem('weatherly-last-city', city);
            localStorage.setItem('weatherly-unit', unit);
        }

        function loadPreferences() {
            const lastCity = localStorage.getItem('weatherly-last-city');
            const lastUnit = localStorage.getItem('weatherly-unit'); // Corrected typo here
            if (lastCity) {
                cityInput.value = lastCity;
            }
            if (lastUnit) {
                unitSelect.value = lastUnit;
            }
        }

        // --- Dynamic Weather Theme Application ---
        function applyWeatherTheme(conditionCode, isDay) {
            const body = document.body;
            body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');

            let themeClass = '';
            
            // WeatherAPI condition codes and mappings to theme classes
            if (isDay) { // Day themes
                if ([1000].includes(conditionCode)) { // Clear/Sunny
                    themeClass = 'sunny';
                } else if ([1003, 1006, 1009, 1030, 1135, 1147].includes(conditionCode)) { // Cloudy, Overcast, Mist, Fog, Freezing Fog
                    themeClass = 'cloudy';
                } else if ([1063, 1150, 1153, 1180, 1183, 1186, 1189, 1192, 1195, 1240, 1243, 1246].includes(conditionCode)) { // Various types of rain
                    themeClass = 'rainy';
                } else if ([1066, 1069, 1072, 1114, 1117, 1204, 1207, 1210, 1213, 1216, 1219, 1222, 1225, 1255, 1258].includes(conditionCode)) { // Snow, Sleet, Ice
                    themeClass = 'snowy';
                } else if ([1087, 1273, 1276, 1279, 1282].includes(conditionCode)) { // Thunder, Lightning (with/without rain/snow)
                    themeClass = 'thunderstorm';
                } else {
                    themeClass = 'cloudy'; // Default for unhandled or general conditions during day
                }
            } else { // Night themes - generally darker
                 if ([1000].includes(conditionCode)) { // Clear/Sunny (Night)
                    themeClass = 'dark'; // Use general dark mode for clear night
                } else { // All other conditions at night
                    themeClass = 'dark'; // Fallback to general dark mode
                }
            }

            // Apply the chosen weather class
            if (!body.classList.contains('dark')) { // Only apply weather theme if manual dark mode is NOT active
                if (themeClass && themeClass !== 'dark') { // Avoid adding 'dark' weather theme if already handled by manual dark mode
                    body.classList.add(themeClass);
                    localStorage.setItem("weatherly-weather-theme", themeClass);
                } else if (themeClass === 'dark' && !body.classList.contains('dark')) { // If night, and not manually dark, apply dark
                     body.classList.add('dark'); // Apply general dark theme for night
                     localStorage.setItem("weatherly-weather-theme", 'dark');
                } else { // Fallback if no specific weather theme
                     localStorage.removeItem("weatherly-weather-theme");
                }
            } else {
                // If manual dark mode is on, ensure weather themes are not active
                body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                localStorage.removeItem("weatherly-weather-theme");
            }
        }


        // --- Fetch Weather ---
        async function fetchWeather(query, unit, isInitialLoad = false) {
            showLoading();
            const url = `https://api.weatherapi.com/v1/forecast.json?key=${apiKey}&q=${encodeURIComponent(query)}&days=3&aqi=yes&alerts=yes`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);

                displayWeather(data, unit);
                updateTime(data.location.localtime);
                updateLastUpdated(data.current.last_updated_epoch * 1000);
                showError(null);

                // Apply dynamic theme based on weather condition
                applyWeatherTheme(data.current.condition.code, data.current.is_day);

                if (!isInitialLoad) {
                     savePreferences(data.location.name, unit);
                }
            } catch (err) {
                showError(err.message || "Unable to fetch weather data.");
                // Ensure default theme if error (unless manual dark mode is active)
                if (!document.body.classList.contains('dark')) {
                    document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                    localStorage.removeItem("weatherly-weather-theme");
                }
            } finally {
                hideLoading();
            }
        }

        // --- Display Weather ---
        function displayWeather(data, unit) {
            const temp = unit === 'f' ? data.current.temp_f : data.current.temp_c;
            const feels = unit === 'f' ? data.current.feelslike_f : data.current.feelslike_c;
            const curr = data.current, loc = data.location, fore = data.forecast.forecastday;

            weatherDiv.innerHTML = `
                <img src="https:${curr.condition.icon}" alt="${curr.condition.text}" title="${curr.condition.text}">
                <div>
                    <h2>${loc.name}, ${loc.country}</h2>
                    <p><strong>${curr.condition.text}</strong></p>
                    <p><i class="fas fa-thermometer-half"></i> ${temp}¬∞${unit.toUpperCase()} (Feels like: ${feels}¬∞)</p>
                </div>
            `;
            detailsDiv.innerHTML = `
                <p><i class="fas fa-tint"></i> Humidity: ${curr.humidity}% &nbsp;|&nbsp; <i class="fas fa-wind"></i> Wind: ${curr.wind_kph} kph</p>
                <p><i class="fas fa-sun"></i> Sunrise: ${fore[0].astro.sunrise} &nbsp;|&nbsp; <i class="fas fa-moon"></i> Sunset: ${fore[0].astro.sunset}</p>
                <p><i class="fas fa-sun"></i> UV Index: ${curr.uv} &nbsp;|&nbsp; <i class="fas fa-smog"></i> AQI: ${curr.air_quality?.pm2_5?.toFixed(1) ?? 'n/a'} PM2.5</p>
            `;

            const currentHour = new Date(data.location.localtime).getHours();
            const hourlyData = fore[0].hour.filter(hour => new Date(hour.time).getHours() >= currentHour)
                               .concat(fore[1] ? fore[1].hour : [])
                               .slice(0, 24);

            hourlyForecastDiv.innerHTML = hourlyData.map(hour => {
                const hourTime = new Date(hour.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const hourlyTemp = unit === 'f' ? hour.temp_f : hour.temp_c;
                return `
                    <div class="hour-card">
                        <p>${hourTime}</p>
                        <img src="https:${hour.condition.icon}" alt="${hour.condition.text}">
                        <p class="temp">${hourlyTemp}¬∞${unit.toUpperCase()}</p>
                        <p>${hour.chance_of_rain}% Rain</p>
                    </div>
                `;
            }).join('');

            forecastDiv.innerHTML = fore.map(day => `
                <div class="day-card">
                    <h4>${new Date(day.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</h4>
                    <img src="https:${day.day.condition.icon}" alt="${day.day.condition.text}">
                    <p>${day.day.condition.text}</p>
                    <p>${day.day.mintemp_c}¬∞C - ${day.day.maxtemp_c}¬∞C</p>
                    <p><i class="fas fa-cloud-rain"></i> ${day.day.daily_chance_of_rain}% Rain</p>
                </div>
            `).join('');

            currentCityForFavorites = loc.name;
        }

        // --- Error Handling ---
        function showError(msg) {
            if (msg) {
                errorDiv.style.display = "block";
                errorDiv.textContent = `‚ö†Ô∏è ${msg}`;
                weatherDiv.innerHTML = "";
                detailsDiv.innerHTML = "";
                hourlyForecastDiv.innerHTML = "";
                forecastDiv.innerHTML = "";
                timeDiv.innerHTML = "";
                lastUpdatedDiv.innerHTML = "";

                // Reset theme to default light if error (unless manual dark mode is active)
                if (!document.body.classList.contains('dark')) {
                    document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                    localStorage.removeItem("weatherly-weather-theme");
                }

                if (msg.includes("Location access denied") || msg.includes("Geolocation is not supported")) {
                    cityInput.classList.add('highlight-input');
                    cityInput.focus();
                    geolocationPrompt.textContent = "GPS unavailable. Please type your city name above.";
                    geolocationPrompt.style.display = 'block';

                    setTimeout(() => {
                        cityInput.classList.remove('highlight-input');
                        geolocationPrompt.style.display = 'none';
                    }, 4000);
                } else {
                    geolocationPrompt.style.display = 'none';
                }

            } else {
                errorDiv.style.display = "none";
                errorDiv.textContent = "";
                cityInput.classList.remove('highlight-input');
                geolocationPrompt.style.display = 'none';
            }
        }

        // --- Get Weather by City/Location ---
        async function getWeatherByCity(e) {
            if(e && e.preventDefault) e.preventDefault();
            const city = cityInput.value.trim();
            const unit = unitSelect.value;
            if (!city) return showError("Please enter a city name.");
            fetchWeather(city, unit, false);
        }

        function getWeatherByLocation(isInitialLoad = true) {
            const unit = unitSelect.value;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coords = `${pos.coords.latitude},${pos.coords.longitude}`;
                        fetchWeather(coords, unit, isInitialLoad);
                    },
                    () => showError("Location access denied or unavailable. Please enter a city manually.")
                );
            } else {
                showError("Geolocation is not supported by your browser. Please enter a city manually.");
            }
        }

        // --- Event Listeners ---
        document.getElementById("loc-form").onsubmit = getWeatherByCity;
        cityBtn.onclick = getWeatherByCity;
        gpsBtn.onclick = () => getWeatherByLocation(false);

        unitSelect.addEventListener("change", () => {
            if (cityInput.value.trim()) {
                getWeatherByCity();
            } else {
                getWeatherByLocation();
            }
        });

        saveFavoriteBtn.addEventListener('click', () => saveFavorite(currentCityForFavorites));
        removeFavoriteBtn.addEventListener('click', removeFavorite);
        favoriteSelect.addEventListener('change', () => {
            const selectedCity = favoriteSelect.value;
            if (selectedCity) {
                cityInput.value = selectedCity;
                getWeatherByCity();
            }
        });

        // --- Initial Load ---
        window.onload = function() {
            loadPreferences();
            if (cityInput.value) {
                getWeatherByCity();
            } else {
                getWeatherByLocation();
            }
            loadFavorites();
        };
    </script>
</body>
</html>