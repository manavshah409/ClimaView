<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>ClimaView ‚Äì Advanced Weather App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, shrink-to-fit=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-touch-fullscreen" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="weather.ico">
    <!-- <link rel="stylesheet" href="weatherapp.css"> -->
    
    <style>
    html {
            scroll-behavior: smooth;
        }
        :root {
            /* Default Light Theme Colors - These are the base, overridden by weather classes */
            --bg: linear-gradient(to top, #eef7fa, #dbeff5); /* A softer, more ethereal light background */
            --card-bg: rgba(255, 255, 255, 0.9); /* Slightly translucent for glassmorphism */
            --text: #2a3a4a; /* Slightly softer deep blue-grey */
            --secondary-text: #5c758a; /* Muted blue-grey */
            --border: #e0e9f0; /* Lighter greyish blue */
            --primary-btn: #4a90e2; /* Vibrant blue */
            --primary-btn-hover: #357bd8; /* Deeper blue */
            --secondary-btn: #e5eef5; /* Lighter grey-blue */
            --secondary-btn-hover: #ccd7e3; /* Muted light blue */
            --error-bg: #ffebeb; /* Soft red for errors */
            --error-text: #c0392b; /* Dark red for errors */

            /* Dark Mode Overrides (for manual toggle) */
            --dark-override-bg: linear-gradient(to bottom, #161c26, #0a0e14); /* Deeper, richer night gradient */
            --dark-override-card-bg: rgba(45, 55, 72, 0.9); /* Darker slate grey, slightly translucent */
            --dark-override-text: #e8f0f7; /* Off-white for dark mode */
            --dark-override-secondary-text: #9ab4c7; /* Lighter grey for dark mode */
            --dark-override-border: #3b4756; /* Muted dark blue */
            --dark-override-primary-btn: #79befc; /* Lighter vibrant blue */
            --dark-override-primary-btn-hover: #5aaee5; /* Slightly darker vibrant blue */
            --dark-override-secondary-btn: #384352; /* Darker secondary */
            --dark-override-secondary-btn-hover: #505d6e; /* Even darker secondary */
            --dark-override-error-bg: #3d2525; /* Dark red for errors */
            --dark-override-error-text: #ff9a9a; /* Lighter red for errors */
        }

        /* Base Body Styles - Will be overridden by weather classes */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background: var(--bg); /* Uses base variable, which can be a gradient */
            color: var(--text);
            transition: background 0.8s ease, color 0.8s ease; /* Smooth transition for dynamic theme changes */
            line-height: 1.6;
            display: flex; /* Make body a flex container */
            flex-direction: column; /* Stack children vertically */
            min-height: 100vh; /* Ensure body takes full viewport height */
            /* Add this for better mobile Safari fixed/background behavior */
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
        }

        /* Manual Dark Mode Toggle - Applies its own set of variables */
        body.dark {
            --bg: var(--dark-override-bg);
            --card-bg: var(--dark-override-card-bg);
            --text: var(--dark-override-text);
            --secondary-text: var(--dark-override-secondary-text);
            --border: var(--dark-override-border);
            --primary-btn: var(--dark-override-primary-btn);
            --primary-btn-hover: var(--dark-override-primary-btn-hover);
            --secondary-btn: var(--dark-override-secondary-btn);
            --secondary-btn-hover: var(--dark-override-secondary-btn-hover);
            --error-bg: var(--dark-override-error-bg);
            --error-text: var(--dark-override-error-text);
        }

        /* --- Dynamic Weather Theming Classes --- */
        /* Sunny / Clear Day */
        body.sunny {
            --bg: radial-gradient(circle at top left, #a0dfff, #67c2f0, #4ca0e2); /* Bright, expansive blue */
            --card-bg: rgba(255, 255, 255, 0.9); /* Slightly more translucent on sunny */
            --text: #1a2a3a;
            --secondary-text: #4d667d;
            --border: #cee8f5;
            --primary-btn: #FFD700; /* Gold */
            --primary-btn-hover: #DAA520;
            --secondary-btn: #FFFCF0; /* Creamy yellow */
            --secondary-btn-hover: #F0E68C;
        }

        /* Cloudy / Overcast */
        body.cloudy {
            --bg: linear-gradient(to bottom right, #B0BEC5, #78909C, #546E7A); /* Muted greys, subtly somber */
            --card-bg: rgba(255, 255, 255, 0.85);
            --text: #37474F;
            --secondary-text: #607D8B;
            --border: #9FB3BF;
            --primary-btn: #78909C;
            --primary-btn-hover: #546E7A;
            --secondary-btn: #CFD8DC;
            --secondary-btn-hover: #B0BEC5;
        }

        /* Rainy */
        body.rainy {
            --bg: linear-gradient(to top, #3e505a, #2c3a4a); /* Deep, dark stormy blue-grey */
            --card-bg: rgba(0, 0, 0, 0.65); /* Dark, more opaque card */
            --text: #E0E0E0;
            --secondary-text: #B0BEC5;
            --border: #546E7A;
            --primary-btn: #81D4FA;
            --primary-btn-hover: #4FC3F7;
            --secondary-btn: #383838;
            --secondary-btn-hover: #2e2e2e;
        }

        /* Snowy */
        body.snowy {
            --bg: linear-gradient(to bottom, #E0F2F7, #CFD8DC, #B0BEC5); /* Icy light blues and greys */
            --card-bg: rgba(255, 255, 255, 0.99);
            --text: #2f3a4a;
            --secondary-text: #5a708a;
            --border: #D1E4E8;
            --primary-btn: #BBDEFB;
            --primary-btn-hover: #90CAF9;
            --secondary-btn: #E3F2FD;
            --secondary-btn-hover: #C5E1F6;
        }

        /* Haze / Mist / Fog */
        body.hazy {
            --bg: linear-gradient(to bottom, #ECEFF1, #CFD8DC); /* Soft, muted greys for hazy feel */
            --card-bg: rgba(255, 255, 255, 0.92);
            --text: #455A64;
            --secondary-text: #78909C;
            --border: #D1D8DC;
            --primary-btn: #90A4AE;
            --primary-btn-hover: #78909C;
            --secondary-btn: #F5F5F5;
            --secondary-btn-hover: #E0E0E0;
        }

        /* Thunderstorm */
        body.thunderstorm {
            --bg: linear-gradient(to top left, #1a1a1a, #2f2f2f, #1f2a3a); /* Deep, threatening darks */
            --card-bg: rgba(0, 0, 0, 0.6);
            --text: #FAFAFA;
            --secondary-text: #CFD8DC;
            --border: #424242;
            --primary-btn: #FFEB3B;
            --primary-btn-hover: #FDD835;
            --secondary-btn: #2b2b2b;
            --secondary-btn-hover: #1e1e1e;
        }

        /* --- Apply variables to elements --- */
        /* Better focus styles for accessibility */
        *:focus {
            outline: none;
        }
        *:focus-visible {
            outline: 3px solid var(--primary-btn-hover);
            outline-offset: 2px;
            border-radius: 6px;
        }
        .controls input[type=text]:focus-visible,
        .controls select:focus-visible,
        .controls button:focus-visible,
        .theme-btn:focus-visible {
            outline: 3px solid var(--primary-btn-hover);
            outline-offset: 2px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2c3e50; /* This remains constant for a strong header identity */
            color: #ecf0f1;
            padding: 1rem 2.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        .header .logo {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header .logo i {
            font-size: 1.5rem;
            color: #8ed0f8;
        }
        .nav {
            display: flex;
            gap: 1.8rem;
        }
        .nav a {
            color: #ecf0f1;
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }
        .nav a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background-color: #8ed0f8;
            transition: width 0.3s ease;
        }
        .nav a:hover::after,
        .nav a.active::after {
            width: 100%;
        }
        .nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        .theme-btn {
            font-size: 1.6rem;
            cursor: pointer;
            user-select: none;
            padding: 8px 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            color: #f1c40f;
            border: none;
            transition: background 0.3s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.08);
        }

        .bg-anim {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: var(--bg); /* Uses dynamic --bg (gradient) */
            transition: background 0.8s ease;
            /* Ensure smooth background on mobile Safari fixed elements */
            -webkit-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
        }

        /* Subtle cloud animation */
        .bg-anim::before,
        .bg-anim::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            opacity: 0.7;
            filter: blur(15px);
            animation: moveClouds 35s linear infinite;
        }
        .bg-anim::before {
            width: 220px;
            height: 220px;
            top: 15%;
            left: -60px;
            animation-delay: 0s;
        }
        .bg-anim::after {
            width: 280px;
            height: 280px;
            top: 55%;
            right: -80px;
            animation-delay: -20s;
        }
        @keyframes moveClouds {
            0% { transform: translateX(0) scale(1); }
            50% { transform: translateX(70px) scale(1.08); opacity: 0.6; }
            100% { transform: translateX(0) scale(1); opacity: 0.7; }
        }
        /* Adjust cloud color/effect based on specific themes */
        body.cloudy .bg-anim::before,
        body.cloudy .bg-anim::after,
        body.rainy .bg-anim::before,
        body.rainy .bg-anim::after,
        body.thunderstorm .bg-anim::before,
        body.thunderstorm .bg-anim::after {
            background: rgba(0, 0, 0, 0.15);
            filter: blur(12px);
            opacity: 0.8;
        }
        body.snowy .bg-anim::before,
        body.snowy .bg-anim::after,
        body.hazy .bg-anim::before,
        body.hazy .bg-anim::after {
            background: rgba(255, 255, 255, 0.7);
        }
        body.dark .bg-anim::before,
        body.dark .bg-anim::after {
            background: rgba(255, 255, 255, 0.08);
            filter: blur(8px);
            opacity: 0.5;
        }


        .main-wrap {
            max-width: 600px;
            margin: 2.8rem auto;
            padding: 2.5rem;
            background: var(--card-bg); /* Uses dynamic --card-bg, now slightly translucent */
            /* Glassmorphism effect */
            backdrop-filter: blur(8px); /* Apply blur to background content */
            -webkit-backdrop-filter: blur(8px); /* For Safari support */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Subtle white border for light themes */
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 6px 20px rgba(0, 0, 0, 0.1); /* Deeper, layered shadow */
            border-radius: 20px;
            margin-bottom: 2.8rem;
            transition: background 0.4s ease, box-shadow 0.4s ease, border 0.4s ease;
            position: relative;
            z-index: 1;
            flex-grow: 1; /* Allow main content to grow and push footer down */
        }
        body.dark .main-wrap {
            background: var(--dark-override-card-bg); /* Uses dark override card bg */
            border: 1px solid rgba(0, 0, 0, 0.3); /* Darker border for dark mode glassmorphism */
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.45), 0 8px 25px rgba(0, 0, 0, 0.25);
        }
        /* Border color adjustment for specific weather themes for better contrast */
        body.rainy .main-wrap, body.thunderstorm .main-wrap {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }


        h1, h2 {
            margin: 0;
            font-weight: 600;
            padding-bottom: 1rem;
            color: var(--text);
        }
        h1 {
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            gap: 18px;
            color: var(--primary-btn);
            letter-spacing: -0.03em;
        }
        /* Text shadow for headings in dark/stormy themes */
        body.rainy h1, body.rainy h2,
        body.thunderstorm h1, body.thunderstorm h2,
        body.dark h1, body.dark h2 {
            text-shadow: 0px 2px 4px rgba(0,0,0,0.3);
        }
        body.rainy h1, body.thunderstorm h1 {
            color: #FFEB3B;
        }


        h2 {
            font-size: 1.8rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
            margin-bottom: 1.8rem;
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--text);
        }

        #time {
            font-size: 1.15rem;
            color: var(--secondary-text);
            padding-top: 0.6rem;
            padding-bottom: 1.3rem;
            text-align: right;
            font-weight: 500;
        }
        #last-update {
            font-size: 0.95rem;
            color: var(--secondary-text);
            text-align: right;
            margin-top: -0.8rem;
            margin-bottom: 0.8rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .controls {
            display: flex;
            gap: 0.8rem;
            margin: 25px 0;
            flex-wrap: wrap;
        }
        .controls input[type=text] {
            flex: 3;
            padding: 15px 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background 0.3s ease, color 0.3s ease;
            background: var(--card-bg);
            color: var(--text);
        }
        .controls input[type=text]:focus {
            border-color: var(--primary-btn);
            box-shadow: 0 0 0 5px rgba(74, 144, 226, 0.3);
        }
        body.dark .controls input[type=text]:focus {
            border-color: var(--dark-override-primary-btn);
            box-shadow: 0 0 0 5px rgba(99, 179, 237, 0.4);
        }

        .controls select,
        .controls button {
            flex: 1;
            padding: 13px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            white-space: nowrap;
        }
        .controls select {
            background: var(--secondary-btn);
            color: var(--text);
            border: 1px solid var(--border);
            /* Custom arrow for select */
            appearance: none;
            -webkit-appearance: none;
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 18px;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23607d8b'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        }

        body.dark .controls select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0aec0'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        }

        .controls select:hover {
            background-color: var(--secondary-btn-hover);
        }

        body.dark .controls select:hover {
            background-color: var(--secondary-btn-hover);
        }


        .controls button {
            background: var(--primary-btn);
            color: #ffffff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.18);
        }
        .controls button:hover {
            background: var(--primary-btn-hover);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
        }
        .controls button:active {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Specific button colors (GPS, Save Fav, Remove Fav) remain hardcoded for consistency regardless of theme */
        #gpsBtn { background: #28a745; color: #fff; }
        #gpsBtn:hover { background: #218838; }
        #saveFavBtn { background: #e74c3c; color: #fff; padding: 13px 20px; margin-left: 0.8rem; }
        #saveFavBtn:hover { background: #c0392b; }
        #favSelect { flex: 2; }
        #removeFavBtn { flex: 1; background: #95a5a6; }
        #removeFavBtn:hover { background: #7f8c8d; }

        body.dark #no-favs { color: var(--dark-override-secondary-text); }

        @keyframes shakeInput {
            0% { transform: translateX(0); } 15% { transform: translateX(-8px); }
            30% { transform: translateX(8px); } 45% { transform: translateX(-6px); }
            60% { transform: translateX(6px); } 75% { transform: translateX(-3px); }
            90% { transform: translateX(3px); } 100% { transform: translateX(0); }
        }
        .highlight-input {
            animation: shakeInput 0.7s ease-in-out;
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 6px rgba(231, 76, 60, 0.35) !important;
        }
        body.dark .highlight-input {
            border-color: #e74c3c !important;
            box-shadow: 0 0 0 6px rgba(231, 76, 60, 0.45) !important;
        }

        #geo-prompt {
            background-color: var(--secondary-btn);
            border-left: 4px solid var(--primary-btn);
            padding: 15px 20px;
            margin-top: 18px;
            border-radius: 10px;
            font-size: 1.05rem;
            color: var(--text);
            display: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
            line-height: 1.4;
        }

        .curr-weather {
            display: flex;
            align-items: center;
            gap: 2rem;
            padding: 1.8rem 0;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            padding-bottom: 2rem;
        }
        .curr-weather h2 { color: var(--text); }
        .curr-weather p { color: var(--secondary-text); }
        .curr-weather p strong { color: var(--text); }
        /* Text shadow for current weather details in dark/stormy themes */
        body.rainy .curr-weather p, body.thunderstorm .curr-weather p, body.dark .curr-weather p {
            text-shadow: 0px 1px 2px rgba(0,0,0,0.2);
        }

        .details-list p {
            margin: 14px 0;
            font-size: 1.08rem;
            color: var(--secondary-text);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .details-list p i {
            color: var(--primary-btn);
            font-size: 1.2em;
        }

        /* Hourly Forecast styles */
        .hourly-scroll {
            display: flex;
            overflow-x: auto;
            gap: 18px;
            padding-bottom: 25px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
            padding-bottom: 2rem;
        }
        .hour-card {
            flex: 0 0 auto;
            width: 120px;
            text-align: center;
            background: var(--secondary-btn);
            border-radius: 15px;
            padding: 15px 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            scroll-snap-align: start;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        .hour-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
        }
        .hour-card p {
            margin: 5px 0;
            font-size: 1em;
            color: var(--text);
            font-weight: 500;
        }
        .hour-card img {
            width: 50px;
            height: 50px;
            margin: 0 auto 10px auto;
        }
        .hour-card .temp {
            font-weight: 600;
            font-size: 1.3em;
            color: var(--primary-btn);
        }
        /* Customize scrollbar for webkit browsers */
        .hourly-scroll::-webkit-scrollbar { height: 12px; }
        .hourly-scroll::-webkit-scrollbar-track { background: var(--border); border-radius: 10px; }
        .hourly-scroll::-webkit-scrollbar-thumb { background: var(--secondary-btn-hover); border-radius: 10px; }
        .hourly-scroll::-webkit-scrollbar-thumb:hover { background: var(--primary-btn); }


        .day-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            padding-top: 1rem;
        }
        .day-card {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            border: 1px solid var(--border);
        }
        .day-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
        }
        .day-card h4 {
            margin: 0 0 0.8rem 0;
            font-size: 1.35rem;
            color: var(--text);
            font-weight: 600;
        }
        .day-card img {
            width: 70px;
            height: 70px;
            margin-bottom: 1rem;
        }
        .day-card p {
            margin: 6px 0;
            font-size: 1.05rem;
            color: var(--secondary-text);
        }
        .day-card p:last-child {
            font-weight: 700;
            color: var(--text);
        }
        body.rainy .day-card p, body.thunderstorm .day-card p, body.dark .day-card p {
            text-shadow: 0px 1px 2px rgba(0,0,0,0.2);
        }

        .error-msg {
            background: var(--error-bg);
            color: var(--error-text);
            border-radius: 10px;
            padding: 18px 25px;
            margin-top: 2rem;
            font-weight: 500;
            letter-spacing: .03em;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
            box-shadow: 0 3px 15px rgba(0,0,0,0.15);
            line-height: 1.4;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-btn);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Footer Styles --- */
        .footer {
            background: #222c3b; /* Consistent dark background for footer */
            color: #b0c0d0; /* Muted light text */
            padding: 2.5rem 2rem;
            margin-top: 3rem; /* Space from main content */
            text-align: center;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.15); /* Subtle shadow at the top */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            flex-shrink: 0; /* Prevent footer from shrinking */
        }

        .footer .footer-logo {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8ed0f8; /* Match header logo icon color */
            margin-bottom: 0.5rem;
        }

        .footer .footer-links {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .footer .footer-links a {
            color: #c0d0e0;
            text-decoration: none;
            font-size: 0.95rem;
            transition: color 0.2s ease;
        }

        .footer .footer-links a:hover {
            color: #8ed0f8; /* Highlight on hover */
        }

        .footer .social-icons {
            display: flex;
            gap: 1.2rem;
            margin-bottom: 1rem;
        }

        .footer .social-icons a {
            color: #c0d0e0;
            font-size: 1.4rem;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .footer .social-icons a:hover {
            color: #8ed0f0; /* Slightly brighter highlight */
            transform: translateY(-3px);
        }

        .footer .copyright {
            font-size: 0.85rem;
            color: #90a0b0;
            margin-bottom: 0.5rem;
        }

        .footer .powered-by {
            font-size: 0.8rem;
            color: #708090;
        }

        .footer .powered-by a {
            color: #8ed0f8;
            text-decoration: none;
            font-weight: 500;
        }

        .footer .powered-by a:hover {
            text-decoration: underline;
        }

        /* Mobile First Approach - Default styles for mobile */
        @media (max-width: 480px) {
            body {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .header {
                flex-direction: column;
                padding: 0.8rem;
                gap: 0.6rem;
                text-align: center;
            }
            
            .header .logo {
                font-size: 1.4rem;
                justify-content: center;
            }
            
            .nav {
                flex-direction: column;
                gap: 0.5rem;
                width: 100%;
            }
            
            .nav a {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                width: 100%;
                text-align: center;
                border-radius: 8px;
            }
            
            .theme-btn {
                margin-top: 0.5rem;
                align-self: center;
            }
            
            .main-wrap {
                margin: 1rem;
                padding: 1rem;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 1.6rem;
                text-align: center;
                justify-content: center;
            }
            
            h2 {
                font-size: 1.3rem;
                text-align: center;
                justify-content: center;
            }
            
            .controls {
                flex-direction: column;
                gap: 0.8rem;
            }
            
            .controls input[type=text],
            .controls select,
            .controls button {
                width: 100%;
                padding: 0.8rem;
                font-size: 1rem;
            }
            
            .curr-weather {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .footer {
                padding: 1rem;
                gap: 0.8rem;
                margin-top: 1.5rem;
            }
            
            .footer .footer-logo {
                font-size: 1.3rem;
            }
            
            .footer .footer-links {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .footer .footer-links a {
                padding: 0.5rem;
                width: 100%;
                text-align: center;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 1rem 1rem;
                gap: 0.8rem;
                text-align: center;
            }
            
            .header .logo {
                font-size: 1.6rem;
                justify-content: center;
            }
            
            .nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }
            
            .nav a {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .theme-btn {
                margin-top: 0.5rem;
                align-self: center;
            }
            .main-wrap {
                padding: 1.5rem;
                margin: 1.5rem auto;
                backdrop-filter: blur(5px); /* Less blur on mobile for performance */
                -webkit-backdrop-filter: blur(5px);
            }
            h1 {
                font-size: 1.8rem;
                justify-content: center;
                text-align: center;
                gap: 10px;
            }
            h2 {
                font-size: 1.4rem;
                justify-content: center;
                text-align: center;
                gap: 8px;
                margin-bottom: 1.2rem;
            }
            #time, #last-update {
                text-align: center;
            }
            .controls {
                flex-direction: column;
                gap: 1rem;
                margin: 20px 0;
            }
            .controls input[type=text],
            .controls select,
            .controls button,
            #favSelect,
            #removeFavBtn {
                width: 100%;
                flex: none;
                padding: 12px 15px;
            }
            #saveFavBtn { margin-left: 0; }

            .curr-weather {
                flex-direction: column;
                text-align: center;
                gap: 1.2rem;
                padding-top: 1.2rem;
                padding-bottom: 1.2rem;
                margin-bottom: 1.5rem;
            }
            .curr-weather img {
                width: 70px;
                height: 70px;
            }
            .curr-weather p { font-size: 1.05rem; }

            .details-list p {
                margin: 10px 0;
                font-size: 1rem;
                gap: 10px;
            }
            .details-list p i { font-size: 1em; }

            .hourly-scroll {
                padding-bottom: 15px;
                margin-bottom: 1.5rem;
                gap: 12px;
            }
            .hour-card {
                width: 100px;
                font-size: 0.9em;
                padding: 12px 8px;
                border-radius: 12px;
            }
            .hour-card img {
                width: 45px;
                height: 45px;
                margin-bottom: 8px;
            }
            .hour-card .temp { font-size: 1.2em; }

            .day-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 1rem;
                padding-top: 0.8rem;
            }
            .day-card {
                padding: 1.2rem;
                border-radius: 15px;
            }
            .day-card h4 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            .day-card img {
                width: 60px;
                height: 60px;
                margin-bottom: 0.8rem;
            }
            .day-card p {
                font-size: 0.95rem;
            }
            .error-msg {
                padding: 15px 20px;
                margin-top: 1.5rem;
                font-size: 0.95rem;
            }
            .spinner {
                width: 60px;
                height: 60px;
                border-width: 7px;
            }

            .footer {
                padding: 1.5rem 1rem;
                gap: 1rem;
                margin-top: 2rem;
                text-align: center;
            }
            
            .footer .footer-logo {
                font-size: 1.4rem;
                justify-content: center;
                margin-bottom: 1rem;
            }
            
            .footer .footer-links {
                gap: 0.8rem;
                flex-direction: column;
                align-items: center;
            }
            
            .footer .footer-links a {
                padding: 0.3rem 0.6rem;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 44px;
            }
            
            .footer .social-icons {
                gap: 1.2rem;
                justify-content: center;
            }
            
            .footer .social-icons a {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .footer .copyright,
            .footer .powered-by {
                text-align: center;
                margin: 0.5rem 0;
            }
        }

        /* Additional responsive breakpoints for smaller phones */
        @media (max-width: 480px) {
            .header {
                padding: 0.8rem;
                gap: 0.6rem;
            }
            
            .header .logo {
                font-size: 1.4rem;
            }
            
            .nav {
                gap: 0.5rem;
            }
            
            .nav a {
                padding: 0.3rem 0.6rem;
                font-size: 0.85rem;
                border-radius: 4px;
            }
            
            .main-wrap {
                margin: 1rem auto;
                padding: 1rem;
            }
            
            .footer {
                padding: 1rem 0.8rem;
            }
            
            .footer .footer-logo {
                font-size: 1.2rem;
            }
            
            .footer .footer-links {
                gap: 0.6rem;
            }
            
            .footer .footer-links a {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }
        }

        /* Extra small devices */
        @media (max-width: 320px) {
            .header {
                padding: 0.6rem;
            }
            
            .header .logo {
                font-size: 1.2rem;
            }
            
            .nav a {
                font-size: 0.8rem;
                padding: 0.2rem 0.4rem;
            }
            
            .footer .footer-logo {
                font-size: 1.1rem;
            }
            
            .footer .footer-links a {
                font-size: 0.85rem;
            }
        }

        /* Extra small devices (iPhone SE, small Android phones) */
        @media (max-width: 375px) {
            .header {
                padding: 0.6rem;
            }
            
            .header .logo {
                font-size: 1.2rem;
            }
            
            .nav a {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .main-wrap {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            h2 {
                font-size: 1.2rem;
            }
            
            .footer {
                padding: 0.8rem;
            }
            
            .footer .footer-logo {
                font-size: 1.1rem;
            }
        }

        /* Mobile-specific improvements for touch devices */
        @media (hover: none) and (pointer: coarse) {
            /* Increase touch targets for mobile */
            .controls button,
            .controls input,
            .controls select,
            .nav a,
            .footer a {
                min-height: 44px; /* Apple's recommended minimum touch target */
                min-width: 44px;
            }
            
            /* Remove hover effects on touch devices */
            .controls button:hover,
            .day-card:hover,
            .hour-card:hover {
                transform: none;
                box-shadow: inherit;
            }
            
            /* Improve text selection on mobile */
            .curr-weather p,
            .details-list p,
            .day-card p {
                -webkit-user-select: text;
                user-select: text;
            }
        }

        /* Ensure proper scrolling on mobile */
        html {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Prevent zoom on input focus (iOS Safari) */
        @media screen and (max-width: 768px) {
            input[type="text"],
            input[type="search"],
            select,
            button {
                font-size: 16px !important;
            }
        }
        
        /* Force mobile layout on devices */
        @media screen and (max-device-width: 768px) {
            .header {
                flex-direction: column !important;
                text-align: center !important;
                padding: 1rem !important;
            }
            
            .nav {
                flex-direction: column !important;
                width: 100% !important;
                gap: 0.5rem !important;
            }
            
            .nav a {
                width: 100% !important;
                text-align: center !important;
                padding: 0.6rem !important;
            }
            
            .main-wrap {
                margin: 1rem !important;
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <header class="header" role="banner">
        <div class="logo" aria-label="ClimaView home"><i class="fas fa-cloud-sun"></i> ClimaView</div>
        <nav class="nav" aria-label="Main navigation">
            <a href="#" class="active">Home</a>
            <a href="#curr-sec">Current</a>
            <a href="#forecast-sec">Forecast</a>
        </nav>
        <button class="theme-btn" id="themeToggle" title="Toggle light/dark theme" aria-label="Toggle theme"><i class="fas fa-adjust"></i></button>
    </header>

    <div class="bg-anim"></div>

    <main class="main-wrap" role="main">
        <form id="loc-form" autocomplete="off">
            <h1><i class="fas fa-cloud-sun-rain"></i> Weather</h1>
            <div id="time"></div>
            <div id="last-update"></div>
            <div class="controls">
                <input type="text" id="cityIn" name="city" placeholder="Enter city or use GPS" aria-label="City name">
                <select id="unitSel" aria-label="Select temperature units">
                    <option value="c">¬∞C</option>
                    <option value="f">¬∞F</option>
                </select>
                <button type="submit" id="cityBtn">Search</button>
                <button type="button" id="gpsBtn" title="Use current location" aria-label="Use current location"><i class="fas fa-map-marker-alt"></i> GPS</button>
                </div>
            <div id="geo-prompt" role="alert"></div>
        </form>

        <section id="fav-sec" style="margin-bottom: 1.5rem;">
            <h2 style="margin-bottom: 1rem;"><i class="fas fa-star"></i> Favorite Locations</h2>
            <div class="controls">
                <select id="favSelect" aria-label="Select a favorite city">
                    <option value="">Select a favorite...</option>
                </select>
                <button type="button" id="removeFavBtn" title="Remove selected favorite" aria-label="Remove favorite"><i class="fas fa-minus-circle"></i> Remove</button>
            </div>
            <p id="no-favs" style="font-style: italic; color: var(--light-secondary-text); margin-top: 10px; text-align: center; display: none;">No favorites saved yet. Search a city and click the ‚ù§Ô∏è icon!</p>
        </section>

        <section id="curr-sec" tabindex="-1" aria-labelledby="currentWeatherHeading">
            <h2 id="currentWeatherHeading"><i class="fas fa-map-marker-alt"></i> Current Weather</h2>
            <div id="weather-display" class="curr-weather"></div>
        </section>

        <section id="hourly-sec" aria-labelledby="hourlyForecastHeading">
            <h2 id="hourlyForecastHeading"><i class="fas fa-clock"></i> Hourly Forecast (Today)</h2>
            <div id="hourly-display" class="hourly-scroll"></div>
        </section>

        <section id="details-sec" aria-labelledby="weatherDetailsHeading">
            <h2 id="weatherDetailsHeading"><i class="fas fa-chart-bar"></i> Weather Details</h2>
            <div id="details-display" class="details-list"></div>
        </section>
        <section id="forecast-sec" aria-labelledby="forecastHeading">
            <h2 id="forecastHeading"><i class="fas fa-calendar-alt"></i> 3-Day Forecast</h2>
            <div id="forecast-display" class="day-grid"></div>
        </section>
        <div id="error-msg" class="error-msg" role="alert" style="display:none"></div>
    </main>

    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <footer class="footer" role="contentinfo">
        <div class="footer-logo">
            <i class="fas fa-cloud-sun"></i> ClimaView
        </div>
        <div class="footer-links">
            <!-- <a href="#">About Us</a>
            <a href="#">Privacy Policy</a>
            <a href="#">Contact</a> -->
            <a href="#top">Back to Top</a>
        </div>
        <!-- <div class="social-icons">
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
            <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="GitHub"><i class="fab fa-github"></i></a>
        </div> -->
        <div class="copyright">
            &copy; 2025. All rights reserved.
        </div>
        <div class="powered-by">
            Powered by <a href="https://www.weatherapi.com/" target="_blank" rel="noopener noreferrer">WeatherAPI.com</a>
        </div>
    </footer>

    <script>
        // WeatherAPI Key - You need to get your own free API key from https://www.weatherapi.com/
        const API_KEY = "c8d6f96dd51e4b65966204756250407"; // Your WeatherAPI key

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const timeDiv = document.getElementById("time");
        const lastUpdatedDiv = document.getElementById("last-update");
        const cityInput = document.getElementById("cityIn");
        const unitSelect = document.getElementById("unitSel");
        const cityBtn = document.getElementById("cityBtn");
        const gpsBtn = document.getElementById("gpsBtn");
        const weatherDiv = document.getElementById("weather-display");
        const detailsDiv = document.getElementById("details-display");
        const hourlyForecastDiv = document.getElementById("hourly-display");
        const forecastDiv = document.getElementById("forecast-display");
        const errorDiv = document.getElementById("error-msg");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const geolocationPrompt = document.getElementById("geo-prompt");

        const favoriteSelect = document.getElementById("favSelect");
        const removeFavoriteBtn = document.getElementById("removeFavBtn");
        const noFavoritesMessage = document.getElementById("no-favs");

        const saveFavoriteBtn = document.createElement('button');
        saveFavoriteBtn.type = 'button';
        saveFavoriteBtn.id = 'saveFavBtn';
        saveFavoriteBtn.title = 'Add current city to favorites';
        saveFavoriteBtn.setAttribute('aria-label', 'Add current city to favorites');
        saveFavoriteBtn.innerHTML = '<i class="fas fa-heart"></i> Save';
        document.querySelector('#loc-form .controls').appendChild(saveFavoriteBtn);

        let currentCityForFavorites = '';

        // --- Theme Toggling ---
        themeToggle.onclick = function() {
            document.body.classList.toggle('dark');
            // When toggling manually, remove any weather-specific classes
            document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
            localStorage.setItem("weatherly-theme", document.body.classList.contains("dark") ? "dark" : "light");
            localStorage.removeItem("weatherly-weather-theme"); // Clear previous weather theme preference
        };

        // Load stored theme on initial DOMContentLoaded
        window.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem("weatherly-theme") === "dark") {
                document.body.classList.add("dark");
            } else {
                // If not manual dark mode, try to load previous weather theme
                const storedWeatherTheme = localStorage.getItem("weatherly-weather-theme");
                if (storedWeatherTheme) {
                    document.body.classList.add(storedWeatherTheme);
                }
            }
        });

        // --- Loading Spinner Functions ---
        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        // --- Time Update Function ---
        function updateTime(localTime) {
            if (localTime) {
                const local = new Date(localTime.replace(' ', 'T'));
                timeDiv.textContent = `üïí Local Time: ${local.toLocaleString()}`;
            } else {
                timeDiv.textContent = "";
            }
        }

        function updateLastUpdated(updatedTime) {
            if (updatedTime) {
                lastUpdatedDiv.textContent = `Last Updated: ${new Date(updatedTime).toLocaleTimeString()}`;
            } else {
                lastUpdatedDiv.textContent = "";
            }
        }

        // --- Favorites Functions ---
        function loadFavorites() {
            const favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            favoriteSelect.innerHTML = '<option value="">Select a favorite...</option>';
            if (favorites.length === 0) {
                noFavoritesMessage.style.display = 'block';
                favoriteSelect.disabled = true;
                removeFavoriteBtn.disabled = true;
            } else {
                noFavoritesMessage.style.display = 'none';
                favoriteSelect.disabled = false;
                removeFavoriteBtn.disabled = false;
                favorites.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    favoriteSelect.appendChild(option);
                });
            }
        }

        function saveFavorite(city) {
            let favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            if (city && !favorites.some(fav => fav.toLowerCase() === city.toLowerCase())) {
                favorites.push(city);
                localStorage.setItem('weatherly-favorites', JSON.stringify(favorites));
                loadFavorites();
                showError(`${city} added to favorites!`);
            } else if (city) {
                showError(`${city} is already in your favorites.`);
            } else {
                showError("Please search for a city first to save it.");
            }
        }

        function removeFavorite() {
            const cityToRemove = favoriteSelect.value;
            if (!cityToRemove) {
                showError("Please select a favorite to remove.");
                return;
            }
            let favorites = JSON.parse(localStorage.getItem('weatherly-favorites') || '[]');
            favorites = favorites.filter(city => city !== cityToRemove);
            localStorage.setItem('weatherly-favorites', JSON.stringify(favorites));
            loadFavorites();
            showError(`${cityToRemove} removed from favorites.`);
            cityInput.value = '';
            if (currentCityForFavorites.toLowerCase() === cityToRemove.toLowerCase()) {
                 weatherDiv.innerHTML = "";
                 detailsDiv.innerHTML = "";
                 hourlyForecastDiv.innerHTML = "";
                 forecastDiv.innerHTML = "";
                 timeDiv.innerHTML = "";
                 lastUpdatedDiv.innerHTML = "";
                 currentCityForFavorites = '';
            }
        }

        // --- Persistence Functions ---
        function savePreferences(city, unit) {
            localStorage.setItem('weatherly-last-city', city);
            localStorage.setItem('weatherly-unit', unit);
        }

        function loadPreferences() {
            const lastCity = localStorage.getItem('weatherly-last-city');
            const lastUnit = localStorage.getItem('weatherly-unit'); // Corrected typo here
            if (lastCity) {
                cityInput.value = lastCity;
            }
            if (lastUnit) {
                unitSelect.value = lastUnit;
            }
        }

        // --- Dynamic Weather Theme Application ---
        function applyWeatherTheme(conditionCode, isDay) {
            const body = document.body;
            body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');

            let themeClass = '';
            
            // WeatherAPI condition codes and mappings to theme classes
            if (isDay) { // Day themes
                if ([1000].includes(conditionCode)) { // Clear/Sunny
                    themeClass = 'sunny';
                } else if ([1003, 1006, 1009, 1030, 1135, 1147].includes(conditionCode)) { // Cloudy, Overcast, Mist, Fog, Freezing Fog
                    themeClass = 'cloudy';
                } else if ([1063, 1150, 1153, 1180, 1183, 1186, 1189, 1192, 1195, 1240, 1243, 1246].includes(conditionCode)) { // Various types of rain
                    themeClass = 'rainy';
                } else if ([1066, 1069, 1072, 1114, 1117, 1204, 1207, 1210, 1213, 1216, 1219, 1222, 1225, 1255, 1258].includes(conditionCode)) { // Snow, Sleet, Ice
                    themeClass = 'snowy';
                } else if ([1087, 1273, 1276, 1279, 1282].includes(conditionCode)) { // Thunder, Lightning (with/without rain/snow)
                    themeClass = 'thunderstorm';
                } else {
                    themeClass = 'cloudy'; // Default for unhandled or general conditions during day
                }
            } else { // Night themes - generally darker
                 if ([1000].includes(conditionCode)) { // Clear/Sunny (Night)
                    themeClass = 'dark'; // Use general dark mode for clear night
                } else { // All other conditions at night
                    themeClass = 'dark'; // Fallback to general dark mode
                }
            }

            // Apply the chosen weather class
            if (!body.classList.contains('dark')) { // Only apply weather theme if manual dark mode is NOT active
                if (themeClass && themeClass !== 'dark') { // Avoid adding 'dark' weather theme if already handled by manual dark mode
                    body.classList.add(themeClass);
                    localStorage.setItem("weatherly-weather-theme", themeClass);
                } else if (themeClass === 'dark' && !body.classList.contains('dark')) { // If night, and not manually dark, apply dark
                     body.classList.add('dark'); // Apply general dark theme for night
                     localStorage.setItem("weatherly-weather-theme", 'dark');
                } else { // Fallback if no specific weather theme
                     localStorage.removeItem("weatherly-weather-theme");
                }
            } else {
                // If manual dark mode is on, ensure weather themes are not active
                body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                localStorage.removeItem("weatherly-weather-theme");
            }
        }


        // --- Fetch Weather ---
        async function fetchWeather(query, unit, isInitialLoad = false) {
            if (!API_KEY || API_KEY === "c8d6f96dd51e4b65966204756250407 ") {
                showError("Please add your WeatherAPI key. Get a free key from https://www.weatherapi.com/signup.aspx");
                return;
            }
            
            showLoading();
            const url = `https://api.weatherapi.com/v1/forecast.json?key=${API_KEY}&q=${encodeURIComponent(query)}&days=3&aqi=yes&alerts=yes`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.error) throw new Error(data.error.message);

                displayWeather(data, unit);
                updateTime(data.location.localtime);
                updateLastUpdated(data.current.last_updated_epoch * 1000);
                showError(null);

                // Apply dynamic theme based on weather condition
                applyWeatherTheme(data.current.condition.code, data.current.is_day);

                if (!isInitialLoad) {
                     savePreferences(data.location.name, unit);
                }
            } catch (err) {
                showError(err.message || "Unable to fetch weather data.");
                // Ensure default theme if error (unless manual dark mode is active)
                if (!document.body.classList.contains('dark')) {
                    document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                    localStorage.removeItem("weatherly-weather-theme");
                }
            } finally {
                hideLoading();
            }
        }

        // --- Display Weather ---
        function displayWeather(data, unit) {
            const temp = unit === 'f' ? data.current.temp_f : data.current.temp_c;
            const feels = unit === 'f' ? data.current.feelslike_f : data.current.feelslike_c;
            const curr = data.current, loc = data.location, fore = data.forecast.forecastday;

            weatherDiv.innerHTML = `
                <img src="https:${curr.condition.icon}" alt="${curr.condition.text}" title="${curr.condition.text}">
                <div>
                    <h2>${loc.name}, ${loc.country}</h2>
                    <p><strong>${curr.condition.text}</strong></p>
                    <p><i class="fas fa-thermometer-half"></i> ${temp}¬∞${unit.toUpperCase()} (Feels like: ${feels}¬∞)</p>
                </div>
            `;
            detailsDiv.innerHTML = `
                <p><i class="fas fa-tint"></i> Humidity: ${curr.humidity}% &nbsp;|&nbsp; <i class="fas fa-wind"></i> Wind: ${curr.wind_kph} kph</p>
                <p><i class="fas fa-sun"></i> Sunrise: ${fore[0].astro.sunrise} &nbsp;|&nbsp; <i class="fas fa-moon"></i> Sunset: ${fore[0].astro.sunset}</p>
                <p><i class="fas fa-sun"></i> UV Index: ${curr.uv} &nbsp;|&nbsp; <i class="fas fa-smog"></i> AQI: ${curr.air_quality?.pm2_5?.toFixed(1) ?? 'n/a'} PM2.5</p>
            `;

            const currentHour = new Date(data.location.localtime).getHours();
            const hourlyData = fore[0].hour.filter(hour => new Date(hour.time).getHours() >= currentHour)
                               .concat(fore[1] ? fore[1].hour : [])
                               .slice(0, 24);

            hourlyForecastDiv.innerHTML = hourlyData.map(hour => {
                const hourTime = new Date(hour.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const hourlyTemp = unit === 'f' ? hour.temp_f : hour.temp_c;
                return `
                    <div class="hour-card">
                        <p>${hourTime}</p>
                        <img src="https:${hour.condition.icon}" alt="${hour.condition.text}">
                        <p class="temp">${hourlyTemp}¬∞${unit.toUpperCase()}</p>
                        <p>${hour.chance_of_rain}% Rain</p>
                    </div>
                `;
            }).join('');

            forecastDiv.innerHTML = fore.map(day => `
                <div class="day-card">
                    <h4>${new Date(day.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })}</h4>
                    <img src="https:${day.day.condition.icon}" alt="${day.day.condition.text}">
                    <p>${day.day.condition.text}</p>
                    <p>${day.day.mintemp_c}¬∞C - ${day.day.maxtemp_c}¬∞C</p>
                    <p><i class="fas fa-cloud-rain"></i> ${day.day.daily_chance_of_rain}% Rain</p>
                </div>
            `).join('');

            currentCityForFavorites = loc.name;
        }

        // --- Error Handling ---
        function showError(msg) {
            if (msg) {
                errorDiv.style.display = "block";
                errorDiv.textContent = `‚ö†Ô∏è ${msg}`;
                weatherDiv.innerHTML = "";
                detailsDiv.innerHTML = "";
                hourlyForecastDiv.innerHTML = "";
                forecastDiv.innerHTML = "";
                timeDiv.innerHTML = "";
                lastUpdatedDiv.innerHTML = "";

                // Reset theme to default light if error (unless manual dark mode is active)
                if (!document.body.classList.contains('dark')) {
                    document.body.classList.remove('sunny', 'cloudy', 'rainy', 'snowy', 'hazy', 'thunderstorm');
                    localStorage.removeItem("weatherly-weather-theme");
                }

                if (msg.includes("Location access denied") || msg.includes("Geolocation is not supported")) {
                    cityInput.classList.add('highlight-input');
                    cityInput.focus();
                    geolocationPrompt.textContent = "GPS unavailable. Please type your city name above.";
                    geolocationPrompt.style.display = 'block';

                    setTimeout(() => {
                        cityInput.classList.remove('highlight-input');
                        geolocationPrompt.style.display = 'none';
                    }, 4000);
                } else {
                    geolocationPrompt.style.display = 'none';
                }

            } else {
                errorDiv.style.display = "none";
                errorDiv.textContent = "";
                cityInput.classList.remove('highlight-input');
                geolocationPrompt.style.display = 'none';
            }
        }

        // --- Get Weather by City/Location ---
        async function getWeatherByCity(e) {
            if(e && e.preventDefault) e.preventDefault();
            const city = cityInput.value.trim();
            const unit = unitSelect.value;
            if (!city) return showError("Please enter a city name.");
            fetchWeather(city, unit, false);
        }

        function getWeatherByLocation(isInitialLoad = true) {
            const unit = unitSelect.value;
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coords = `${pos.coords.latitude},${pos.coords.longitude}`;
                        fetchWeather(coords, unit, isInitialLoad);
                    },
                    () => showError("Location access denied or unavailable. Please enter a city manually.")
                );
            } else {
                showError("Geolocation is not supported by your browser. Please enter a city manually.");
            }
        }

        // --- Event Listeners ---
        document.getElementById("loc-form").onsubmit = getWeatherByCity;
        cityBtn.onclick = getWeatherByCity;
        gpsBtn.onclick = () => getWeatherByLocation(false);

        unitSelect.addEventListener("change", () => {
            if (cityInput.value.trim()) {
                getWeatherByCity();
            } else {
                getWeatherByLocation();
            }
        });

        saveFavoriteBtn.addEventListener('click', () => saveFavorite(currentCityForFavorites));
        removeFavoriteBtn.addEventListener('click', removeFavorite);
        favoriteSelect.addEventListener('change', () => {
            const selectedCity = favoriteSelect.value;
            if (selectedCity) {
                cityInput.value = selectedCity;
                getWeatherByCity();
            }
        });

        // --- Initial Load ---
        window.onload = function() {
            loadPreferences();
            if (cityInput.value) {
                getWeatherByCity();
            } else {
                getWeatherByLocation();
            }
            loadFavorites();
        };
    </script>
</body>
</html>